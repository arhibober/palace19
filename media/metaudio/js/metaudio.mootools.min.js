window.metaudio={init:function(e){function j(b,d){var a=function(){};a={onload:a,onplay:a,onstop:a,onresume:a,onpause:a,onfinish:a,onseek:a,whileplaying:a,whileloading:a};for(var c in a)b[c]=d[c]?d[c]:a[c]}var h=new Element("audio");h&&["progress","canplay","canplaythrough","play","pause","ended","seeking","timeupdate"].each(function(b){Element.NativeEvents[b]=1});var k=new Swiff(e.swfurl,{id:"metaudio-player",container:"metaudio-placeholder",params:{menu:!1,scale:"noScale"},properties:{name:"metaudio-player"}});
k&&(k=document.id(k));window.metaudio={sounds:{},html5player:{create:function(b){var d=new Element("audio",{src:b.url}),a={url:b.url,player:d,paused:!1,play:function(){d.play()},stop:function(){d.pause()},resume:function(){d.play()},pause:function(){d.pause()},getTotal:function(){return a.duration},getLoaded:function(){var c=a.duration;if(c)for(range in c=0,a.buffered)c+=range;return c},getDuration:function(){return d.duration*1E3},getPosition:function(){return d.currentTime*1E3},setPosition:function(c){d.currentTime=
c/1E3}};j(a,b);d.addEvents({progress:function(){a.whileloading()},canplay:function(){a.onload()},canplaythrough:function(){a.whileloading()},play:function(){if(a.paused)a.paused=!1,a.onresume();else a.onplay()},pause:function(){a.paused=!0;a.onpause()},ended:function(){a.paused=!1;a.onfinish()},seeking:function(){a.onseek(a.currentTime*1E3)},timeupdate:function(){a.whileplaying()}});return a}},flashplayer:{player:k,create:function(b){var d=this,a=this.player;a.mpCreate(b.url);var c={url:b.url,loading:!0,
playing:!1,play:function(){a.mpPlay(this.url)},stop:function(){a.mpStop(this.url)},resume:function(){a.mpResume(this.url)},pause:function(){a.mpPause(this.url)},getTotal:function(){return a.mpGetBytesTotal(this.url)},getLoaded:function(){return a.mpGetBytesLoaded(this.url)},getDuration:function(){return a.mpGetDuration(this.url)},getPosition:function(){return a.mpGetPosition(this.url)},setPosition:function(c){a.mpSetPosition(this.url,c)},getPeak:function(){return a.mpGetPeak()},getWaveform:function(){return a.mpGetWaveform()}};
j(c,b);window.clearInterval(this.interval);this.interval=window.setInterval(function(){d.poll()},100);return c},poll:function(){for(var b in window.metaudio.sounds){var d=window.metaudio.sounds[b];d.playing&&d.whileplaying();if(d.loading){d.whileloading();var a=d.getTotal(),c=d.getLoaded();if(a>0&&c>=a)d.loading=!1}}}},create:function(b){function d(c){return["probably","maybe"].contains(h.canPlayType("audio/"+c))}var a=b.url,c,l=/\.ogg$/.test(a)&&d("ogg")||/\.(m4a|mp4)$/.test(a)&&d("mp4")||/\.mp3$/.test(a)&&
d("mpeg");if(l&&!e.spectrogram&&!e.peak)c=this.html5player;else if(this.flashplayer.player&&/\.(m4a|mp4|mp3)$/.test(a))c=this.flashplayer;else if(l)c=this.html5player;a=c.create(b);return this.sounds[b.url]=a},onload:function(b){this.sounds[b].onload()},onplay:function(b){b=this.sounds[b];b.playing=!0;b.onplay()},onstop:function(b){b=this.sounds[b];b.playing=!1;b.onstop()},onresume:function(b){b=this.sounds[b];b.playing=!0;b.onresume()},onpause:function(b){b=this.sounds[b];b.playing=!1;b.onpause()},
onfinish:function(b){b=this.sounds[b];b.playing=!1;b.onfinish()},onseek:function(b,d){this.sounds[b].onseek(d)},pauseAllBut:function(b){for(var d in this.sounds)d!=b&&this.sounds[d].pause()}}}};
function metaudioPlayer(e){function j(){var c=document.createElement("canvas");return!(!c||!c.getContext||!c.getContext("2d"))}function h(c){if(c)return Math.floor(c/6E4)+":"+("0"+Math.floor(c%6E4/1E3)).slice(-2);return"-:--"}e=Object.merge({autoPlayNext:!1,clock:!0,peak:!1,spectrogram:!1,statusbar:!0},e);var k=new Class({initialize:function(){this.visualizer=(new Element("div",{"class":"metaudio-peak"})).adopt((new Element("div")).adopt(new Element("div",{"class":"metaudio-left"}),new Element("div",
{"class":"metaudio-right"})))},toElement:function(){return this.visualizer},update:function(c){var a=this.visualizer;c?(a.getElement(".metaudio-left").setStyle("height",100*c.left+"%"),a.getElement(".metaudio-right").setStyle("height",100*c.right+"%")):a.getChildren().setStyle("height",0)}}),b=new Class({initialize:function(){var c=this,a=document.createElement("canvas");a.width=256;a.height=20;var b=window.G_vmlCanvasManager;b&&b.initElement(a);c.spectrogram=(new Element("div",{"class":"metaudio-spectrogram",
events:{click:function(){c.spectrogram.toggleClass("metaudio-swap");c.update();return!1}}})).adopt(a)},toElement:function(){return this.spectrogram},update:function(c){function a(c){if(c.length>0){var e=b.getSize(),g=e.x;e=e.y;d.beginPath();d.moveTo(0,(e*c[0]+e)/2);for(var f=1;f<256;f++)d.lineTo(f*g/256,(e*c[f]+e)/2);d.stroke();d.closePath()}}var b=this.spectrogram.getElement("canvas"),d=b&&b.getContext&&b.getContext("2d");if(d&&(d.clearRect(0,0,b.width,b.height),c)){d.save();var e=b.getParent().hasClass("metaudio-swap");
d.lineWidth="1";d.strokeStyle="#9cf";a(e?c.right:c.left);d.strokeStyle="#000";a(e?c.left:c.right);d.restore()}}}),d=new Class({initialize:function(){var c=this,a=(new Element("div",{"class":"metaudio-tooltip"})).setStyle("display","none").inject(document.body);c._statusbar=(new Element("div",{"class":"metaudio-statusbar",events:{click:function(a){a=c._getPlayheadPosition(a);c.source&&c.source.setPosition(a);return!1},mousemove:function(b){var d=c._statusbar.getCoordinates();a.setStyles({left:b.page.x+
20,top:d.top+d.height+10,display:"block"}).set("text",h(c._getPlayheadPosition(b)))},mouseout:function(){a.setStyle("display","none").empty()}}})).adopt(c._loading=new Element("div",{"class":"metaudio-loading"}),c._position=new Element("div",{"class":"metaudio-position"}))},toElement:function(){return this._statusbar},source:!1,updateLoaded:function(){var c=this.source?this.source.getTotal():0;this._loading.setStyle("width",100*(c?this.source.getLoaded()/c:0)+"%")},updatePosition:function(c){var a=
this.source?this.source.getDuration():0;this._position.setStyle("width",100*(c&&a?c/a:0)+"%")},_getPlayheadPosition:function(a){var b=this._statusbar.getCoordinates();a=(a.page.x-b.left)/b.width;if(this.source&&(b=this.source.getDuration()))return Math.floor(a*b);return 0}}),a=new Class({initialize:function(){this._clock=(new Element("div",{"class":"metaudio-timing"})).adopt(this._current=new Element("span",{"class":"metaudio-current"}),new Element("span",{html:" / "}),this._total=new Element("span",
{"class":"metaudio-total"}));this.updateLoaded();this.updatePosition()},toElement:function(){return this._clock},source:!1,updateLoaded:function(){var a=this.source?this.source.getDuration():0;this._total.set("text",h(a))},updatePosition:function(a){this._current.set("text",h(a))}});document.addEvent("domready",function(){e.spectrogram=e.spectrogram&&j();window.metaudio.init(e);if(typeof window.metaudio.create!="undefined"){var c=document.getElements("a.metaudio-player");c.each(function(h){var i=
e.clock&&new a,j=e.peak&&new k,m=e.spectrogram&&new b,l=new Element("div",{"class":"metaudio-control"}),g=e.statusbar&&new d;[g,l,m,j,i].each(function(a){a&&$(a).inject(h,"after")});h.addEvent("click",function(a){a.preventDefault()});var f=h.getParents("li")[0];$$(f.getElements("a").filter(function(a){return!c.contains(a)})).addEvent("click",function(a){a.stopPropagation()});g&&(g.updateLoaded(),g.updatePosition());i&&(i.updateLoaded(),i.updatePosition());f.addEvent("click",function(){var a=h.href;
window.metaudio.pauseAllBut(a);f.getSiblings().removeClass("sm2_active");var b=window.metaudio.sounds[a];if(!b)b=window.metaudio.create({url:a,usePeakData:!0,useWaveformData:!!m,onload:function(){g&&g.updateLoaded()},onplay:function(){f.addClass("sm2_playing")},onstop:function(){f.removeClass("sm2_playing sm2_paused")},onpause:function(){f.removeClass("sm2_playing");f.addClass("sm2_paused")},onresume:function(){f.removeClass("sm2_paused");f.addClass("sm2_playing")},onfinish:function(){f.removeClass("sm2_playing").removeClass("sm2_paused");
g&&g.updatePosition();e.autoPlayNext&&f.getNext().addClass("sm2_active").triggerEvent("click")},onseek:function(a){g&&g.updatePosition(a);i&&i.updatePosition(a)},whileloading:function(){g&&g.updateLoaded();i&&i.updateLoaded()},whileplaying:function(){var a=this.getPosition();g&&g.updatePosition(a);i&&i.updatePosition(a);j&&this.getPeak&&j.update(this.getPeak());m&&this.getWaveform&&m.update(this.getWaveform())}}),g&&(g.source=b),i&&(i.source=b);f.hasClass("sm2_active")&&(f.hasClass("sm2_paused")?
b.resume():f.hasClass("sm2_playing")?b.pause():b.play());f.addClass("sm2_active")})});if(document.all){var h=function(){var a=document.all["metaudio-player"];a&&a.removeNode(!0)};window.addEventListener?window.addEventListener("unload",h,!1):window.attachEvent?window.attachEvent("onunload",h):window.unload=h}}})};
